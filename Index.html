<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oil & Dev Operations</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- GLOBAL STYLES --- */
    body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; color: #333; }

    /* HEADER */
    header { text-align: center; margin-bottom: 30px; }
    h1 { margin: 0; color: #102027; font-size: 1.8rem; }
    .date-badge { display: inline-block; margin-top: 8px; padding: 4px 12px; background: #e0e0e0; border-radius: 12px; font-size: 0.85rem; color: #555; }

    /* HEADERS */
    .grid-title { margin-left:10px; color:#546e7a; border-left: 5px solid #ccc; padding-left: 10px; margin-top: 40px; margin-bottom: 15px; font-size: 1.1rem;}

    /* --- CARDS & GRIDS --- */
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white; padding: 20px; border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      border-top: 5px solid #ccc; transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-3px); }

    .card-cat { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; color: #78909c; letter-spacing: 1px; }
    .card-label { font-size: 1rem; font-weight: 600; margin: 5px 0 0 0; color: #37474f; }
    .card-value { font-size: 2.2rem; font-weight: 700; color: #263238; margin: 10px 0; }
    
    .stats-row { display: flex; gap: 10px; font-size: 0.8rem; }
    .stat-badge { padding: 4px 8px; border-radius: 4px; background: #eceff1; color: #455a64; }

    /* --- COMPARISON BLOCKS (DELTAS) --- */
    .comp-wrapper { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 40px; }
    .comp-box { flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid #ccc; }
    .comp-header { font-size: 0.8rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px; }
    .comp-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
    .comp-label { color: #555; font-weight: 500; font-size: 0.9rem; }
    .comp-val { font-weight: bold; font-size: 1rem; }

    /* --- CHARTS SECTION --- */
    .charts-wrapper { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
    .chart-box { flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .chart-title { font-size: 1.1rem; color: #455a64; font-weight: bold; }
    .chart-total { font-size: 0.9rem; background: #eceff1; padding: 5px 10px; border-radius: 5px; color: #333; font-weight: bold; }

    /* DAILY BREAKDOWN TABLE */
    .daily-summary { display: flex; justify-content: space-between; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; color: #666; }
    .day-stat { 
        text-align: center; 
        min-width: 65px; /* Ensures space for breakdown */
        margin: 0 2px;
    }
    .day-name { font-weight: bold; color: #555; font-size: 0.85rem; margin-bottom: 5px;}
    .day-total { font-weight: 800; font-size: 1.1rem; color: #333; border-bottom: 1px solid #ddd; margin-bottom: 5px; padding-bottom: 2px; }
    .breakdown-row { display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 2px; }

    /* COLORS */
    .cat-Flota { border-top-color: #9C27B0; }
    .cat-Combustible { border-top-color: #1565C0; }
    .cat-AdBlue { border-top-color: #2E7D32; }
    .cat-General { border-top-color: #607D8B; }
    .cat-Costos { border-top-color: #FBC02D; }

  </style>
</head>
<body>

  <header>
    <h1>Daily Operations Report</h1>
    <div class="date-badge" id="last-updated">Updating data...</div>
  </header>

  <h3 class="grid-title" style="border-color: #1565C0;">Operaciones (KPIs)</h3>
  <div class="kpi-container" id="ops-grid">
    <div style="color:#888;">Loading Dashboard...</div>
  </div>

  <h3 class="grid-title"></h3>
  <div class="kpi-container" id="finance-grid"></div>

  <h3 class="grid-title" style="border-color: #607D8B;">AnÃ¡lisis de Variaciones (Deltas)</h3>
  <div class="comp-wrapper">
    <div class="comp-box" style="border-top-color: #FF9800;">
      <div class="comp-header" style="color: #FF9800;">VS Mes Anterior (MoM)</div>
      <div id="mom-container"></div>
    </div>
    <div class="comp-box" style="border-top-color: #9C27B0;">
      <div class="comp-header" style="color: #9C27B0;">VS AÃ±o Anterior (YoY)</div>
      <div id="yoy-container"></div>
    </div>
  </div>

  <h3 class="grid-title" style="border-color: #2E7D32;">Abastecimiento</h3>
  <div class="charts-wrapper">
    
    <div class="chart-box">
      <div class="chart-header">
        <div class="chart-title">â›½ Combustible (Litros)</div>
        <div class="chart-total" id="diesel-total-badge">Total: ...</div>
      </div>
      <canvas id="dieselChart"></canvas>
      <div class="daily-summary" id="diesel-summary"></div>
    </div>

    <div class="chart-box">
      <div class="chart-header">
        <div class="chart-title">ðŸ’§ AdBlue (Litros)</div>
        <div class="chart-total" id="adblue-total-badge">Total: ...</div>
      </div>
      <canvas id="adblueChart"></canvas>
      <div class="daily-summary" id="adblue-summary"></div>
    </div>

  </div>

  <script>
    // ============================================
    // âš ï¸ PASTE YOUR NEW DEPLOYMENT URL HERE âš ï¸
    // ============================================
    const API_URL = 'https://script.google.com/macros/s/AKfycbwABwenmqwoNZKN5qTFicP7YWMYHUmKXWB6s0xPGnotrm9Hx-3u3S7Egc7_vc1EaFNr/exec';

    async function initDashboard() {
      try {
        const response = await fetch(API_URL);
        const data = await response.json();
        
        document.getElementById('last-updated').innerText = "Last Updated: " + data.updated;
        renderCards(data.kpis);
        renderCharts(data.weekly);

      } catch (error) {
        console.error("Error:", error);
        document.getElementById('ops-grid').innerHTML = "Error loading data. Please check URL.";
      }
    }

    function renderCards(kpis) {
      const opsContainer = document.getElementById('ops-grid');
      const finContainer = document.getElementById('finance-grid');
      const momContainer = document.getElementById('mom-container');
      const yoyContainer = document.getElementById('yoy-container');
      
      opsContainer.innerHTML = ''; finContainer.innerHTML = '';
      momContainer.innerHTML = ''; yoyContainer.innerHTML = '';

      // Helper: Centralized Trend Logic (Red/Green + Arrows)
      const getTrend = (val) => {
          const strVal = val ? val.toString() : "";
          const isNeg = strVal.includes('-'); 
          return {
              arrow: isNeg ? 'â–¼' : 'â–²',
              color: isNeg ? '#d32f2f' : '#2e7d32', // Red or Green Text
              bg:    isNeg ? '#ffebee' : '#e8f5e9'  // Red or Green BG
          };
      };

    kpis.forEach(item => {
        if (!item.value && item.category !== 'Comparativa') return;

        const momTrend = getTrend(item.mom);
        const yoyTrend = getTrend(item.yoy);

        // --- A. LOGIC FOR COMPARISONS (DELTAS) ---
        if (item.category === 'Comparativa') {
            
            // 1. Identify Special Row (Quantity/Unidades)
            const isSpecial = item.label.toLowerCase().includes('quantity') || item.label.toLowerCase().includes('unidades');

            // 2. Define Styles (Top border + background for special row)
            const rowStyle = isSpecial 
                ? 'border-top: 2px solid #ccc; margin-top: 8px; padding-top: 8px; background-color: #f1f3f4; padding-left: 8px; border-radius: 4px;' 
                : '';
            
            // 3. Define Text (Bold for special row)
            const textStyle = isSpecial ? 'font-weight: 800; color: #333;' : '';

            // 4. Remove Arrow ONLY if special
            const arrowSymbol = isSpecial ? '' : momTrend.arrow; // Use same arrow logic for both cols

            // Helper to generate HTML
            const rowHtml = (label, trend, val) => `
                <div class="comp-row" style="${rowStyle}">
                    <span class="comp-label" style="${textStyle}">${label}</span>
                    <strong class="comp-val" style="color:${trend.color}; ${textStyle}">
                        ${isSpecial ? '' : trend.arrow} ${val}
                    </strong>
                </div>`;
            
            momContainer.innerHTML += rowHtml(item.label, momTrend, item.mom);
            yoyContainer.innerHTML += rowHtml(item.label, yoyTrend, item.yoy);
            return;
        }

        // --- B. LOGIC FOR NORMAL CARDS ---
        let targetContainer = (item.category === 'Costos') ? finContainer : opsContainer;

        const html = `
          <div class="card cat-${item.category}">
            <div class="card-cat">${item.category}</div>
            <div class="card-label">${item.label}</div>
            <div class="card-value">${item.value} <span style="font-size:0.5em; color:#999">${item.unit || ''}</span></div>
            <div class="stats-row">
              <span class="stat-badge" style="color:${momTrend.color}; background:${momTrend.bg}">MoM: ${item.mom}</span>
              <span class="stat-badge" style="color:${yoyTrend.color}; background:${yoyTrend.bg}">YoY: ${item.yoy}</span>
            </div>
          </div>`;
        targetContainer.innerHTML += html;
      });
    }

    function renderCharts(weeklyData) {
      const labels = weeklyData.map(d => d.day);

      // --- 1. HELPER: Format Numbers (No decimals) ---
      // Rounds to whole number and adds thousands separators (12.500)
      const fmt = (num) => Math.round(Number(num) || 0).toLocaleString('es-AR');

      // --- 2. CALCULATE TOTALS ---
      const d_Totals = weeklyData.map(d => (Number(d.d_arg)||0) + (Number(d.d_blp)||0) + (Number(d.d_tct)||0));
      const a_Totals = weeklyData.map(d => (Number(d.a_arg)||0) + (Number(d.a_blp)||0) + (Number(d.a_tct)||0));
      
      // Weekly Sum
      const d_WeekSum = d_Totals.reduce((a, b) => a + b, 0);
      const a_WeekSum = a_Totals.reduce((a, b) => a + b, 0);

      // Update Top Badges
      document.getElementById('diesel-total-badge').innerText = `Total Semana: ${fmt(d_WeekSum)} L`;
      document.getElementById('adblue-total-badge').innerText = `Total Semana: ${fmt(a_WeekSum)} L`;

      // --- 3. BUILD DAILY BREAKDOWN (THE DISCRIMINATION TABLE) ---
      const d_Summary = document.getElementById('diesel-summary');
      const a_Summary = document.getElementById('adblue-summary');
      d_Summary.innerHTML = ''; a_Summary.innerHTML = '';

      weeklyData.forEach((d, i) => {
        const dayShort = d.day.substring(0,3);

        // Helper to create the mini-rows
        const makeRow = (label, val, color) => `
            <div class="breakdown-row" style="color:${color}">
               <span>${label}:</span> <span>${fmt(val)}</span>
            </div>`;

        // Diesel Breakdown
        d_Summary.innerHTML += `
          <div class="day-stat">
            <div class="day-name">${dayShort}</div>
            <div class="day-total">${fmt(d_Totals[i])}</div>
            ${makeRow('Arg', d.d_arg, '#0D47A1')}
            ${makeRow('BLP', d.d_blp, '#1976D2')}
            ${makeRow('TCT', d.d_tct, '#64B5F6')}
          </div>`;

        // AdBlue Breakdown
        a_Summary.innerHTML += `
          <div class="day-stat">
            <div class="day-name">${dayShort}</div>
            <div class="day-total">${fmt(a_Totals[i])}</div>
            ${makeRow('Arg', d.a_arg, '#1B5E20')}
            ${makeRow('BLP', d.a_blp, '#388E3C')}
            ${makeRow('TCT', d.a_tct, '#81C784')}
          </div>`;
      });

      // --- 4. RENDER CHARTS ---
      const commonOptions = {
        responsive: true,
        plugins: { legend: { display: false } }, // Hide Legend
        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
      };

      // Diesel Chart
      new Chart(document.getElementById('dieselChart'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Argentina', data: weeklyData.map(d => d.d_arg), backgroundColor: '#0D47A1' },
            { label: 'BLP',       data: weeklyData.map(d => d.d_blp), backgroundColor: '#1976D2' },
            { label: 'TCT',       data: weeklyData.map(d => d.d_tct), backgroundColor: '#64B5F6' }
          ]
        },
        options: commonOptions
      });

      // AdBlue Chart
      new Chart(document.getElementById('adblueChart'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'Argentina', data: weeklyData.map(d => d.a_arg), backgroundColor: '#1B5E20' },
            { label: 'BLP',       data: weeklyData.map(d => d.a_blp), backgroundColor: '#388E3C' },
            { label: 'TCT',       data: weeklyData.map(d => d.a_tct), backgroundColor: '#81C784' }
          ]
        },
        options: commonOptions
      });
    }

    // Start App
    initDashboard();
  </script>
</body>
</html>