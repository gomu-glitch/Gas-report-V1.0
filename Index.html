<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Combustibles y desempeÃ±o</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* GLOBAL STYLES */
    body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f4f6f8; margin: 0; padding: 20px; color: #333; }
    
    /* LOGIN */
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f4f6f8; display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 350px; }
    .login-box input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
    .login-btn { width: 100%; padding: 12px; background: #1565C0; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
    .login-btn:hover { background: #0D47A1; }

    /* HEADER */
    header { text-align: center; margin-bottom: 30px; }
    h1 { margin: 0; color: #102027; font-size: 1.8rem; }
    .date-badge { display: inline-block; margin-top: 8px; padding: 4px 12px; background: #e0e0e0; border-radius: 12px; font-size: 0.85rem; color: #555; }
    
    .nav-container { display: flex; justify-content: center; gap: 20px; margin-top: 25px; }
    .nav-btn { padding: 10px 30px; border: none; background: white; border-radius: 20px; font-weight: bold; color: #777; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; }
    .nav-btn.active { background: #1565C0; color: white; transform: scale(1.05); box-shadow: 0 4px 10px rgba(21, 101, 192, 0.3); }

    /* LAYOUT */
    .grid-title { margin-left:10px; color:#546e7a; border-left: 5px solid #ccc; padding-left: 10px; margin-top: 40px; margin-bottom: 15px; font-size: 1.1rem;}
    .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
    
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid #ccc; transition: transform 0.2s; }
    .card:hover { transform: translateY(-3px); }
    .card-cat { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; color: #78909c; letter-spacing: 1px; }
    .card-label { font-size: 1rem; font-weight: 600; margin: 5px 0 0 0; color: #37474f; }
    .card-value { font-size: 2.2rem; font-weight: 700; color: #263238; margin: 10px 0; }
    .stats-row { display: flex; gap: 10px; font-size: 0.8rem; }
    .stat-badge { padding: 4px 8px; border-radius: 4px; background: #eceff1; color: #455a64; }

    /* DELTAS */
    .comp-wrapper { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 40px; }
    .comp-box { flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid #ccc; }
    .comp-header { font-size: 0.8rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px; }
    .comp-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
    .comp-label { color: #555; font-weight: 500; font-size: 0.9rem; }
    .comp-val { font-weight: bold; font-size: 1rem; }

    /* CHARTS */
    .charts-wrapper { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
    .chart-box { flex: 1; min-width: 400px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .chart-title { font-size: 1.1rem; color: #455a64; font-weight: bold; }
    .chart-total { font-size: 0.9rem; background: #eceff1; padding: 5px 10px; border-radius: 5px; color: #333; font-weight: bold; }

    /* CHART BODY */
    .chart-body { display: flex; gap: 20px; align-items: flex-start; }
    .chart-canvas-container { flex: 1; min-width: 0; height: 300px; } 

    .summary-table { width: 180px; font-size: 0.85rem; border-collapse: collapse; background: #fafafa; border-radius: 8px; overflow: hidden; flex-shrink: 0; }
    .summary-table th { background: #eceff1; padding: 8px; text-align: left; font-weight: bold; color: #555; text-transform: uppercase; font-size: 0.75rem; }
    .summary-table td { padding: 8px; border-bottom: 1px solid #eee; }
    .summary-total { font-weight: 800; color: #000; font-size: 1rem; border-top: 2px solid #ddd; background: white; }
    .pct-badge { font-size: 0.7rem; color: #777; background: #eee; padding: 1px 4px; border-radius: 3px; margin-left: 4px; }

    @media (max-width: 768px) {
        .chart-body { flex-direction: column; }
        .summary-table { width: 100%; margin-bottom: 15px; }
    }

    /* BREAKDOWN */
    .daily-summary { display: flex; justify-content: space-between; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; color: #666; overflow-x: auto;}
    .day-stat { text-align: center; min-width: 65px; margin: 0 2px; }
    .breakdown-row { display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 2px; }

    /* COLORS */
    .cat-Flota { border-top-color: #9C27B0; }
    .cat-Combustible { border-top-color: #1565C0; }
    .cat-AdBlue { border-top-color: #2E7D32; }
    .cat-General { border-top-color: #607D8B; }
    .cat-Costos { border-top-color: #FBC02D; }
  </style>
</head>
<body>

  <div id="login-overlay">
    <div class="login-box">
      <h2>ðŸ”’ Restricted Access</h2>
      <p>Enter access code to view report.</p>
      <input type="password" id="access-code" placeholder="Enter Password" onkeyup="if(event.key==='Enter') attemptLogin()">
      <button onclick="attemptLogin()" class="login-btn">Access Dashboard</button>
      <p id="login-error" style="color: red; display: none; margin-top: 10px;">Incorrect Password</p>
    </div>
  </div>

  <div id="main-app" style="display: none;">
      <header>
        <h1>Reporte diario de operaciones</h1>
        <div class="date-badge" id="last-updated">Updating...</div>
        
        <div class="nav-container">
          <button class="nav-btn active" onclick="switchFleet('Fleet1', this)">RRC</button>
          <button class="nav-btn" onclick="switchFleet('Fleet2', this)">OWL</button>
        </div>
      </header>

      <div id="dashboard-content">
        
        <h3 class="grid-title" style="border-color: #1565C0;">Operaciones (KPIs)</h3>
        <div class="kpi-container" id="ops-grid"></div>

        <h3 class="grid-title"></h3>
        <div class="kpi-container" id="finance-grid"></div>

        <h3 class="grid-title" style="border-color: #607D8B;">AnÃ¡lisis de Variaciones (Deltas)</h3>
        <div class="comp-wrapper">
          <div class="comp-box" style="border-top-color: #FF9800;">
            <div class="comp-header" style="color: #FF9800;">VS Mes Anterior (MoM)</div>
            <div id="mom-container"></div>
          </div>
          <div class="comp-box" style="border-top-color: #9C27B0;">
            <div class="comp-header" style="color: #9C27B0;">VS AÃ±o Anterior (YoY)</div>
            <div id="yoy-container"></div>
          </div>
        </div>

        <h3 class="grid-title" style="border-color: #2E7D32;">Consumo Semanal</h3>
        <div class="charts-wrapper">
          
          <div class="chart-box">
            <div class="chart-header">
              <div class="chart-title"> Diesel (Litros)</div>
              <div class="chart-total" id="diesel-total-badge">...</div>
            </div>
            
            <div class="chart-body">
                <div id="diesel-table-container"></div>
                <div class="chart-canvas-container">
                    <canvas id="dieselChart"></canvas>
                </div>
            </div>
            <div class="daily-summary" id="diesel-summary"></div>
          </div>

          <div class="chart-box">
            <div class="chart-header">
              <div class="chart-title"> AdBlue (Litros)</div>
              <div class="chart-total" id="adblue-total-badge">...</div>
            </div>
            
            <div class="chart-body">
                <div id="adblue-table-container"></div>
                <div class="chart-canvas-container">
                    <canvas id="adblueChart"></canvas>
                </div>
            </div>
            <div class="daily-summary" id="adblue-summary"></div>
          </div>

        </div>
      </div>
  </div>

  <script>
    // ================= CONFIGURATION =================
    const APP_PASSWORD = "trucks2026"; 
    const API_URL = 'https://script.google.com/macros/s/AKfycbw7MzDcX8bMw3iSUkmrMgNGnHjCQsvQbGRlGt7ZlHupPEQG96gnCsvrNWxeQR3ESLWZ/exec'; 
    // =================================================

    let GLOBAL_DATA = [];
    let chartD = null;
    let chartA = null;
    const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];

    window.onload = function() {
      if (localStorage.getItem('oil_auth') === 'true') { showDashboard(); }
    };
    function attemptLogin() {
      if (document.getElementById('access-code').value === APP_PASSWORD) {
        localStorage.setItem('oil_auth', 'true'); showDashboard();
      } else { document.getElementById('login-error').style.display = 'block'; }
    }
    function showDashboard() {
      document.getElementById('login-overlay').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      initDashboard();
    }

    async function initDashboard() {
      try {
        const response = await fetch(API_URL);
        const json = await response.json();
        GLOBAL_DATA = json.allRows;
        document.getElementById('last-updated').innerText = "Last Updated: " + json.updated;
        loadFleet('Fleet1');
      } catch (error) { console.error(error); }
    }

    function switchFleet(fleetName, btn) {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadFleet(fleetName);
    }

    function loadFleet(groupName) {
      const fleetData = GLOBAL_DATA.filter(item => item.group === groupName);
      
      const weeklyData = fleetData.filter(item => DAYS.includes(item.category));
      
      // FIX: Filter out 'Info' AND Days so they don't appear as Cards
      const kpiData = fleetData.filter(item => !DAYS.includes(item.category) && item.category !== 'Info');
      
      const yearRow = fleetData.find(item => item.category === 'Info' && item.label === 'Year');
      const weekRow = fleetData.find(item => item.category === 'Info' && item.label === 'Week');
      const info = {
          year: yearRow ? yearRow.value : '2026',
          week: weekRow ? weekRow.value : '-'
      };

      renderCards(kpiData);
      renderCharts(weeklyData, info);
    }

    function renderCards(kpis) {
      const ops = document.getElementById('ops-grid');
      const fin = document.getElementById('finance-grid');
      const mom = document.getElementById('mom-container');
      const yoy = document.getElementById('yoy-container');
      ops.innerHTML=''; fin.innerHTML=''; mom.innerHTML=''; yoy.innerHTML='';

      const getTrend = (val) => {
          const str = val ? val.toString() : "";
          const isNeg = str.includes('-'); 
          return { arrow: isNeg?'â–¼':'â–²', color: isNeg?'#d32f2f':'#2e7d32', bg: isNeg?'#ffebee':'#e8f5e9' };
      };

      kpis.forEach(item => {
        if(!item.value && item.category !== 'Comparativa') return;
        const mT = getTrend(item.mom);
        const yT = getTrend(item.yoy);

        if(item.category === 'Comparativa') {
           const isSpec = item.label.toLowerCase().includes('quantity') || item.label.toLowerCase().includes('unidades');
           const rStyle = isSpec ? 'border-top:2px solid #ccc; margin-top:8px; padding-top:8px; background-color:#f1f3f4; padding-left:8px; border-radius:4px;' : '';
           const tStyle = isSpec ? 'font-weight:800; color:#333' : '';
           const arrow = isSpec ? '' : mT.arrow;
           const html = (lbl, tr, val) => `<div class="comp-row" style="${rStyle}"><span class="comp-label" style="${tStyle}">${lbl}</span><strong class="comp-val" style="color:${tr.color};${tStyle}">${arrow} ${val}</strong></div>`;
           mom.innerHTML += html(item.label, mT, item.mom);
           yoy.innerHTML += html(item.label, yT, item.yoy);
           return;
        }

        let target = (item.category === 'Costos') ? fin : ops;
        target.innerHTML += `
          <div class="card cat-${item.category}">
            <div class="card-cat">${item.category}</div>
            <div class="card-label">${item.label}</div>
            <div class="card-value">${item.value} <span style="font-size:0.5em; color:#999">${item.unit||''}</span></div>
            <div class="stats-row"><span class="stat-badge" style="color:${mT.color}; background:${mT.bg}">MoM: ${item.mom}</span><span class="stat-badge" style="color:${yT.color}; background:${yT.bg}">YoY: ${item.yoy}</span></div>
          </div>`;
      });
    }

    function renderCharts(weeklyData, info) {
       if(chartD) chartD.destroy();
       if(chartA) chartA.destroy();
       
       const fmt = (n) => Math.round(Number(n)||0).toLocaleString('es-AR');
       const labels = weeklyData.map(d => d.category);

       // === ROBUST PARSER ===
       // Handles numbers with commas (5,911) by stripping non-numeric characters
       const parse = (val) => {
           if (!val) return 0;
           let str = val.toString();
           if(str.includes("Cargando")) return 0; 
           
           // Remove anything that is NOT a digit, a minus sign, or a dot (decimal)
           // This effectively deletes commas and spaces.
           let clean = str.replace(/[^\d.-]/g, ''); 
           
           return Number(clean) || 0;
       };

       const d_ArgRaw = weeklyData.map(d => parse(d.d_arg));
       const d_BLPRaw = weeklyData.map(d => parse(d.d_blp));
       const d_TCTRaw = weeklyData.map(d => parse(d.d_tct));
       
       const a_ArgRaw = weeklyData.map(d => parse(d.a_arg));
       const a_BLPRaw = weeklyData.map(d => parse(d.a_blp));
       const a_TCTRaw = weeklyData.map(d => parse(d.a_tct));

       const sum = (arr) => arr.reduce((a,b)=>a+b, 0);
       
       const d_Stats = { arg: sum(d_ArgRaw), blp: sum(d_BLPRaw), tct: sum(d_TCTRaw), total: sum(d_ArgRaw) + sum(d_BLPRaw) + sum(d_TCTRaw) };
       const a_Stats = { arg: sum(a_ArgRaw), blp: sum(a_BLPRaw), tct: sum(a_TCTRaw), total: sum(a_ArgRaw) + sum(a_BLPRaw) + sum(a_TCTRaw) };

       document.getElementById('diesel-total-badge').innerText = `Total: ${fmt(d_Stats.total)} L`;
       document.getElementById('adblue-total-badge').innerText = `Total: ${fmt(a_Stats.total)} L`;

       // SIDE TABLES
       const buildTable = (stats, containerId) => {
           const getPct = (val) => stats.total > 0 ? Math.round((val/stats.total)*100) + '%' : '0%';
           const html = `
             <table class="summary-table">
                <tr><th colspan="2">SEMANA</th></tr>
                <tr><td>AÃ±o</td><td style="text-align:right">${info.year}</td></tr>
                <tr><td>Semana</td><td style="text-align:right">${info.week}</td></tr>
                <tr><td colspan="2" style="background:#fff; height:5px;"></td></tr>
                <tr><td>Argentina</td><td style="text-align:right"><b>${fmt(stats.arg)}</b> <span class="pct-badge">${getPct(stats.arg)}</span></td></tr>
                <tr><td>BLP</td><td style="text-align:right"><b>${fmt(stats.blp)}</b> <span class="pct-badge">${getPct(stats.blp)}</span></td></tr>
                <tr><td>TCT</td><td style="text-align:right"><b>${fmt(stats.tct)}</b> <span class="pct-badge">${getPct(stats.tct)}</span></td></tr>
                <tr class="summary-total"><td>Total</td><td style="text-align:right">${fmt(stats.total)}</td></tr>
             </table>
           `;
           document.getElementById(containerId).innerHTML = html;
       };

       buildTable(d_Stats, 'diesel-table-container');
       buildTable(a_Stats, 'adblue-table-container');

       // BREAKDOWN TABLE
       const dSum = document.getElementById('diesel-summary');
       const aSum = document.getElementById('adblue-summary');
       dSum.innerHTML=''; aSum.innerHTML='';
       
       weeklyData.forEach((d, i) => {
         const day = d.category.substring(0,3);
         const row = (l,v,c) => `<div class="breakdown-row" style="color:${c}"><span>${l}:</span><span>${fmt(v)}</span></div>`;
         
         const dDayTotal = d_ArgRaw[i] + d_BLPRaw[i] + d_TCTRaw[i];
         dSum.innerHTML += `<div class="day-stat"><div style="font-weight:bold;margin-bottom:5px; color:#555">${day}</div><div style="font-weight:800;border-bottom:1px solid #ddd;margin-bottom:2px">${fmt(dDayTotal)}</div>${row('Arg',d_ArgRaw[i],'#0D47A1')}${row('BLP',d_BLPRaw[i],'#1976D2')}${row('TCT',d_TCTRaw[i],'#64B5F6')}</div>`;
         
         const aDayTotal = a_ArgRaw[i] + a_BLPRaw[i] + a_TCTRaw[i];
         aSum.innerHTML += `<div class="day-stat"><div style="font-weight:bold;margin-bottom:5px; color:#555">${day}</div><div style="font-weight:800;border-bottom:1px solid #ddd;margin-bottom:2px">${fmt(aDayTotal)}</div>${row('Arg',a_ArgRaw[i],'#1B5E20')}${row('BLP',a_BLPRaw[i],'#388E3C')}${row('TCT',a_TCTRaw[i],'#81C784')}</div>`;
       });

       // GRAPHS
       const cfg = { 
           responsive:true, 
           maintainAspectRatio: false, 
           plugins:{legend:{display:false}}, 
           scales:{x:{stacked:true},y:{stacked:true}},
           barPercentage: 0.8,
           categoryPercentage: 0.9
       };
       
       chartD = new Chart(document.getElementById('dieselChart'), {
         type:'bar', data: { labels:labels, datasets:[
           {data:d_ArgRaw, backgroundColor:'#0D47A1'},
           {data:d_BLPRaw, backgroundColor:'#1976D2'},
           {data:d_TCTRaw, backgroundColor:'#64B5F6'}
         ]}, options:cfg
       });

       chartA = new Chart(document.getElementById('adblueChart'), {
         type:'bar', data: { labels:labels, datasets:[
           {data:a_ArgRaw, backgroundColor:'#1B5E20'},
           {data:a_BLPRaw, backgroundColor:'#388E3C'},
           {data:a_TCTRaw, backgroundColor:'#81C784'}
         ]}, options:cfg
       });
    }
  </script>
</body>
</html>
